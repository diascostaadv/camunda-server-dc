# Workers Platform - Makefile
VM_USER     ?= ubuntu
VM_HOST     ?= 201.23.69.65
SSH_PORT    ?= 22
SSH_KEY     ?= ~/.ssh/azure_vm
REMOTE_DIR  ?= ~/camunda-server-dc/camunda-workers-platform

SSH_FLAGS := -i $(SSH_KEY) -p $(SSH_PORT) -o IdentitiesOnly=yes -o StrictHostKeyChecking=no
SCP_FLAGS := -i $(SSH_KEY) -P $(SSH_PORT) -o IdentitiesOnly=yes -o StrictHostKeyChecking=no
SSH := ssh $(SSH_FLAGS) $(VM_USER)@$(VM_HOST)
SCP := scp $(SCP_FLAGS)

.PHONY: deploy
deploy: copy-files
	@echo "üöÄ Deploying Workers Platform..."
	@echo "‚èπÔ∏è  Stopping existing containers..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose -f docker-compose.yml down"
	@echo "üî® Rebuilding images (no cache)..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose -f docker-compose.yml build --no-cache"
	@echo "üöÄ Starting services..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose -f docker-compose.yml up -d"
	@echo "‚úÖ Workers Platform deployed and restarted with fresh images"

.PHONY: deploy-fast
deploy-fast: copy-files
	@echo "‚ö° Fast deploying Workers Platform (reusing cached images)..."
	@echo "‚èπÔ∏è  Stopping existing containers..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose -f docker-compose.yml down"
	@echo "üöÄ Starting services..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose -f docker-compose.yml up -d"
	@echo "‚úÖ Workers Platform deployed (fast mode)"

.PHONY: copy-files
copy-files:
	@echo "üìÅ Copying Workers files..."
	$(SSH) "mkdir -p $(REMOTE_DIR)"
	$(SCP) -r . $(VM_USER)@$(VM_HOST):$(REMOTE_DIR)/
	@echo "‚úÖ Files copied"

.PHONY: status
status:
	@echo "üìä Workers status..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose ps"

.PHONY: logs
logs:
	@echo "üìã Workers logs..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose logs -f"

.PHONY: restart
restart:
	@echo "üîÑ Restarting Workers Platform..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose down && docker compose up -d"
	@echo "‚úÖ Workers Platform restarted"

.PHONY: rebuild
rebuild:
	@echo "üî® Rebuilding Workers Platform (no cache)..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose down && docker compose build --no-cache && docker compose up -d"
	@echo "‚úÖ Workers Platform rebuilt and restarted"

.PHONY: stop
stop:
	@echo "‚èπÔ∏è Stopping Workers Platform..."
	$(SSH) "cd $(REMOTE_DIR) && docker compose down"
	@echo "‚úÖ Workers Platform stopped"