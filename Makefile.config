# ============================================================================
# COMANDOS DE CONFIGURA√á√ÉO - Extens√£o do Makefile Principal
# ============================================================================
# Comandos adicionais para gerenciamento de configura√ß√£o centralizada
# Include este arquivo no Makefile principal: include Makefile.config
# ============================================================================

# Diret√≥rio de configura√ß√£o compartilhada
CONFIG_DIR := shared/config

# ============================================================================
# COMANDOS DE CONFIGURA√á√ÉO
# ============================================================================

.PHONY: config-validate config-show config-export config-diff config-sync config-test

# Valida todas as configura√ß√µes de ambiente
config-validate:
	@echo "$(YELLOW)üîç Validating environment configurations...$(RESET)"
	@python3 -c "from shared.config import get_config; c=get_config(); c.validate_all(); print('‚úÖ Local config valid')" || echo "‚ùå Local config invalid"
	@ENVIRONMENT=atlas python3 -c "from shared.config import get_config; c=get_config(); c.validate_all(); print('‚úÖ Atlas config valid')" 2>/dev/null || echo "‚ö†Ô∏è  Atlas config not configured"
	@ENVIRONMENT=production python3 -c "from shared.config import get_config; c=get_config(); c.validate_all(); print('‚úÖ Production config valid')" 2>/dev/null || echo "‚ö†Ô∏è  Production config not configured"

# Mostra configura√ß√£o atual
config-show:
	@echo "$(CYAN)üìã Current Configuration ($(ENVIRONMENT))$(RESET)"
	@python3 -c "from shared.config import get_config; c=get_config(); c.print_configuration(show_secrets=False)"

# Mostra configura√ß√£o com secrets (cuidado!)
config-show-secrets:
	@echo "$(RED)üîê Configuration with Secrets (BE CAREFUL!)$(RESET)"
	@read -p "$(RED)Show sensitive information? [y/N]: $(RESET)" confirm && [ "$$confirm" = "y" ] || exit 1
	@python3 -c "from shared.config import get_config; c=get_config(); c.print_configuration(show_secrets=True)"

# Exporta configura√ß√£o para arquivo .env
config-export:
	@if [ -z "$(FILE)" ]; then echo "$(RED)‚ùå Usage: make config-export FILE=.env.new$(RESET)"; exit 1; fi
	@echo "$(BLUE)üì§ Exporting configuration to $(FILE)...$(RESET)"
	@python3 -c "from shared.config import get_config; c=get_config(); c.export_to_env_file('$(FILE)')"
	@echo "$(GREEN)‚úÖ Configuration exported to $(FILE)$(RESET)"

# Compara configura√ß√µes entre ambientes
config-diff:
	@echo "$(YELLOW)üîÄ Comparing environment configurations...$(RESET)"
	@echo "Local vs Atlas:"
	@diff -u --color=always .env.local .env.atlas 2>/dev/null || echo "$(YELLOW)Differences found$(RESET)"
	@echo "\nLocal vs Production:"
	@diff -u --color=always .env.local .env.production 2>/dev/null || echo "$(YELLOW)Differences found$(RESET)"

# Sincroniza configura√ß√µes entre projetos
config-sync:
	@echo "$(BLUE)üîÑ Synchronizing configurations across projects...$(RESET)"
	@for proj in $(PLATFORM_DIR) $(GATEWAY_DIR) $(WORKERS_DIR); do \
		if [ -f "$$proj/.env.local" ]; then \
			echo "  Updating $$proj/.env.local..."; \
			python3 -c "from shared.config import get_config; c=get_config('local'); c.export_to_env_file('$$proj/.env.local')"; \
		fi; \
	done
	@echo "$(GREEN)‚úÖ Configurations synchronized$(RESET)"

# Testa conex√µes com configura√ß√£o atual
config-test:
	@echo "$(CYAN)üß™ Testing connections with current configuration...$(RESET)"
	@echo "Testing MongoDB connection..."
	@python3 -c "from shared.config import get_mongodb_config; from pymongo import MongoClient; c=get_mongodb_config(); client=MongoClient(c.get_connection_string(), **c.get_connection_options()); client.server_info(); print('  ‚úÖ MongoDB: Connected')" 2>/dev/null || echo "  ‚ùå MongoDB: Failed"
	@echo "Testing Camunda connection..."
	@curl -s -f -u demo:demo http://localhost:8080/engine-rest/engine > /dev/null && echo "  ‚úÖ Camunda: Connected" || echo "  ‚ùå Camunda: Failed"
	@echo "Testing Gateway connection..."
	@curl -s -f http://localhost:8000/health > /dev/null && echo "  ‚úÖ Gateway: Connected" || echo "  ‚ùå Gateway: Failed"

# ============================================================================
# COMANDOS DE MIGRA√á√ÉO
# ============================================================================

.PHONY: migrate-config migrate-to-atlas migrate-to-production

# Migra configura√ß√µes antigas para novo formato
migrate-config:
	@echo "$(YELLOW)üîÑ Migrating to new configuration format...$(RESET)"
	@python3 scripts/migrate_config.py
	@echo "$(GREEN)‚úÖ Configuration migrated$(RESET)"

# Prepara configura√ß√£o para Atlas
migrate-to-atlas:
	@echo "$(BLUE)‚òÅÔ∏è  Migrating to Atlas configuration...$(RESET)"
	@cp .env.template .env.atlas
	@echo "ENVIRONMENT=atlas" >> .env.atlas
	@echo "EXTERNAL_SERVICES_MODE=true" >> .env.atlas
	@echo "$(YELLOW)Please edit .env.atlas with your MongoDB Atlas credentials$(RESET)"

# Prepara configura√ß√£o para produ√ß√£o
migrate-to-production:
	@echo "$(MAGENTA)üöÄ Preparing production configuration...$(RESET)"
	@cp .env.template .env.production
	@echo "ENVIRONMENT=production" >> .env.production
	@echo "EXTERNAL_SERVICES_MODE=true" >> .env.production
	@echo "DEBUG=false" >> .env.production
	@echo "$(YELLOW)Please edit .env.production with production credentials$(RESET)"

# ============================================================================
# COMANDOS DE MONITORAMENTO E DIAGN√ìSTICO
# ============================================================================

.PHONY: diag diag-full diag-network diag-services

# Diagn√≥stico r√°pido do sistema
diag:
	@echo "$(CYAN)üè• System Diagnostics$(RESET)"
	@echo "\nüìä Docker Status:"
	@docker version --format 'Client: {{.Client.Version}} | Server: {{.Server.Version}}' 2>/dev/null || echo "‚ùå Docker not running"
	@echo "\nüì¶ Containers:"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "No containers"
	@echo "\nüåê Networks:"
	@docker network ls --format "table {{.Name}}\t{{.Driver}}\t{{.Scope}}" 2>/dev/null || echo "No networks"
	@echo "\nüíæ Volumes:"
	@docker volume ls --format "table {{.Name}}\t{{.Driver}}" 2>/dev/null || echo "No volumes"

# Diagn√≥stico completo
diag-full: diag
	@echo "\n$(YELLOW)üîç Detailed Service Diagnostics$(RESET)"
	@$(MAKE) config-test
	@echo "\nüìà Resource Usage:"
	@docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}" 2>/dev/null || echo "Unable to get stats"

# Diagn√≥stico de rede
diag-network:
	@echo "$(CYAN)üåê Network Diagnostics$(RESET)"
	@echo "\nTesting internal connectivity..."
	@docker exec camunda-platform-standalone-camunda-1 ping -c 1 postgres 2>/dev/null && echo "  ‚úÖ Platform ‚Üí Database" || echo "  ‚ùå Platform ‚Üí Database"
	@docker exec camunda-workers-platform-worker-hello-world-1 curl -s http://camunda:8080 > /dev/null 2>&1 && echo "  ‚úÖ Workers ‚Üí Platform" || echo "  ‚ùå Workers ‚Üí Platform"
	@if [ -d "$(GATEWAY_DIR)" ]; then \
		docker exec camunda-worker-api-gateway-gateway-1 curl -s http://rabbitmq:15672 > /dev/null 2>&1 && echo "  ‚úÖ Gateway ‚Üí RabbitMQ" || echo "  ‚ùå Gateway ‚Üí RabbitMQ"; \
	fi

# Diagn√≥stico de servi√ßos externos
diag-services:
	@echo "$(CYAN)üåç External Services Diagnostics$(RESET)"
	@echo "\nChecking MongoDB Atlas..."
	@python3 -c "from shared.config import get_config; c=get_config('atlas'); print(f'  URI: {c.MONGODB_URI[:30]}...')" 2>/dev/null || echo "  ‚ö†Ô∏è  Atlas not configured"
	@echo "\nChecking external APIs..."
	@curl -s -f http://201.23.67.197:8080/engine-rest/engine > /dev/null && echo "  ‚úÖ Remote Camunda" || echo "  ‚ùå Remote Camunda"

# ============================================================================
# COMANDOS DE BACKUP E RESTORE
# ============================================================================

.PHONY: backup backup-config backup-data restore restore-config

# Backup completo
backup:
	@echo "$(YELLOW)üíæ Creating complete backup...$(RESET)"
	@mkdir -p backups/$(shell date +%Y%m%d_%H%M%S)
	@$(MAKE) backup-config
	@$(MAKE) backup-data
	@echo "$(GREEN)‚úÖ Backup completed$(RESET)"

# Backup de configura√ß√µes
backup-config:
	@echo "$(BLUE)üìã Backing up configurations...$(RESET)"
	@mkdir -p backups/config
	@cp -r shared/config backups/config/shared_$(shell date +%Y%m%d_%H%M%S)
	@for env in local atlas production; do \
		[ -f ".env.$$env" ] && cp .env.$$env backups/config/ || true; \
	done
	@echo "$(GREEN)‚úÖ Configurations backed up$(RESET)"

# Backup de dados
backup-data:
	@echo "$(BLUE)üíæ Backing up data...$(RESET)"
	@cd $(PLATFORM_DIR) && make backup-db
	@if [ -d "$(GATEWAY_DIR)" ]; then \
		docker exec camunda-worker-api-gateway-mongodb-1 mongodump --out /backup 2>/dev/null || echo "‚ö†Ô∏è  MongoDB backup skipped"; \
	fi

# Restore de configura√ß√£o
restore-config:
	@if [ -z "$(BACKUP)" ]; then echo "$(RED)‚ùå Usage: make restore-config BACKUP=backups/config/20240101_120000$(RESET)"; exit 1; fi
	@echo "$(YELLOW)üì• Restoring configuration from $(BACKUP)...$(RESET)"
	@cp -r $(BACKUP)/* .
	@echo "$(GREEN)‚úÖ Configuration restored$(RESET)"

# ============================================================================
# COMANDOS DE TESTING AVAN√áADO
# ============================================================================

.PHONY: test-all test-unit test-integration test-e2e test-performance

# Executa todos os testes
test-all:
	@echo "$(CYAN)üß™ Running all tests...$(RESET)"
	@python3 run_tests.py all

# Testes unit√°rios
test-unit:
	@echo "$(BLUE)üß™ Running unit tests...$(RESET)"
	@python3 run_tests.py unit

# Testes de integra√ß√£o
test-integration:
	@echo "$(YELLOW)üß™ Running integration tests...$(RESET)"
	@python3 run_tests.py integration

# Testes end-to-end
test-e2e:
	@echo "$(MAGENTA)üß™ Running end-to-end tests...$(RESET)"
	@python3 run_tests.py e2e

# Teste de performance
test-performance:
	@echo "$(RED)‚ö° Running performance tests...$(RESET)"
	@python3 -m pytest tests/performance/ -v --benchmark-only

# ============================================================================
# COMANDOS DE DOCUMENTA√á√ÉO
# ============================================================================

.PHONY: docs docs-serve docs-build

# Gera documenta√ß√£o
docs-build:
	@echo "$(BLUE)üìö Building documentation...$(RESET)"
	@python3 -m pdoc --html --output-dir docs/api shared/config
	@echo "$(GREEN)‚úÖ Documentation built in docs/api$(RESET)"

# Serve documenta√ß√£o localmente
docs-serve:
	@echo "$(CYAN)üåê Serving documentation at http://localhost:8080$(RESET)"
	@python3 -m http.server 8080 --directory docs/api

# Abre documenta√ß√£o
docs:
	@echo "$(GREEN)üìñ Opening documentation...$(RESET)"
	@open docs/api/index.html 2>/dev/null || xdg-open docs/api/index.html 2>/dev/null || echo "Please open docs/api/index.html"

# ============================================================================
# HELP ESTENDIDO
# ============================================================================

.PHONY: help-config

help-config:
	@echo "$(WHITE)‚öôÔ∏è  CONFIGURATION MANAGEMENT COMMANDS$(RESET)"
	@echo ""
	@echo "$(GREEN)VALIDATION & TESTING:$(RESET)"
	@echo "  make config-validate    - Validate all environment configs"
	@echo "  make config-show        - Show current configuration"
	@echo "  make config-test        - Test connections with current config"
	@echo "  make config-diff        - Compare environment configurations"
	@echo ""
	@echo "$(BLUE)MIGRATION:$(RESET)"
	@echo "  make migrate-config     - Migrate to new config format"
	@echo "  make migrate-to-atlas   - Prepare Atlas configuration"
	@echo "  make migrate-to-production - Prepare production config"
	@echo ""
	@echo "$(CYAN)DIAGNOSTICS:$(RESET)"
	@echo "  make diag              - Quick system diagnostics"
	@echo "  make diag-full         - Complete diagnostics"
	@echo "  make diag-network      - Network connectivity test"
	@echo "  make diag-services     - External services check"
	@echo ""
	@echo "$(YELLOW)BACKUP & RESTORE:$(RESET)"
	@echo "  make backup            - Complete backup"
	@echo "  make backup-config     - Backup configurations only"
	@echo "  make restore-config BACKUP=path - Restore configuration"
	@echo ""
	@echo "$(MAGENTA)TESTING:$(RESET)"
	@echo "  make test-all          - Run all tests"
	@echo "  make test-unit         - Run unit tests"
	@echo "  make test-integration  - Run integration tests"
	@echo "  make test-e2e          - Run end-to-end tests"
	@echo "  make test-performance  - Run performance tests"